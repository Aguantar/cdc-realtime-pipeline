{
  "id": null,
  "uid": "cdc-pipeline-main",
  "title": "CDC Realtime Pipeline",
  "tags": [
    "cdc",
    "flink",
    "clickhouse"
  ],
  "timezone": "Asia/Seoul",
  "refresh": "10s",
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "panels": [
    {
      "id": 1,
      "title": "Total Orders",
      "type": "stat",
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 0,
        "y": 0
      },
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "PDEE91DDB90597936"
      },
      "targets": [
        {
          "rawSql": "SELECT count() as total FROM cdc_pipeline.raw_orders WHERE op IN ('c', 'u')",
          "refId": "A",
          "format": 1
        }
      ],
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 100
              },
              {
                "color": "red",
                "value": 1000
              }
            ]
          },
          "color": {
            "mode": "thresholds"
          }
        }
      },
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        },
        "colorMode": "background",
        "graphMode": "none"
      }
    },
    {
      "id": 2,
      "title": "Avg CDC Latency",
      "type": "stat",
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 4,
        "y": 0
      },
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "PDEE91DDB90597936"
      },
      "targets": [
        {
          "rawSql": "SELECT round(avg(cdc_latency_ms), 1) as avg_latency FROM cdc_pipeline.raw_orders WHERE op IN ('c', 'u', 'd') AND source_ts >= now() - INTERVAL 1 HOUR",
          "refId": "A",
          "format": 1
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "thresholds": {
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 100
              },
              {
                "color": "red",
                "value": 1000
              }
            ]
          },
          "color": {
            "mode": "thresholds"
          }
        }
      },
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        },
        "colorMode": "background",
        "graphMode": "none"
      }
    },
    {
      "id": 3,
      "title": "Active Alerts",
      "type": "stat",
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 8,
        "y": 0
      },
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "PDEE91DDB90597936"
      },
      "targets": [
        {
          "rawSql": "SELECT count() as alerts FROM cdc_pipeline.anomaly_alerts WHERE detected_at >= now() - INTERVAL 1 HOUR",
          "refId": "A",
          "format": 1
        }
      ],
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "orange",
                "value": 1
              },
              {
                "color": "red",
                "value": 5
              }
            ]
          },
          "color": {
            "mode": "thresholds"
          }
        }
      },
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        },
        "colorMode": "background",
        "graphMode": "none"
      }
    },
    {
      "id": 4,
      "title": "Total Volume (KRW)",
      "type": "stat",
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 12,
        "y": 0
      },
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "PDEE91DDB90597936"
      },
      "targets": [
        {
          "rawSql": "SELECT sum(total_amount) as volume FROM cdc_pipeline.raw_orders WHERE op IN ('c', 'u')",
          "refId": "A",
          "format": 1
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "currencyKRW",
          "thresholds": {
            "steps": [
              {
                "color": "blue",
                "value": null
              }
            ]
          },
          "color": {
            "mode": "thresholds"
          }
        }
      },
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        },
        "colorMode": "background",
        "graphMode": "none"
      }
    },
    {
      "id": 10,
      "title": "Symbols Tracked",
      "type": "stat",
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 16,
        "y": 0
      },
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "PDEE91DDB90597936"
      },
      "targets": [
        {
          "rawSql": "SELECT uniq(symbol) as symbols FROM cdc_pipeline.raw_orders",
          "refId": "A",
          "format": 1
        }
      ],
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              {
                "color": "purple",
                "value": null
              }
            ]
          },
          "color": {
            "mode": "thresholds"
          }
        }
      },
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        },
        "colorMode": "background",
        "graphMode": "none"
      }
    },
    {
      "id": 11,
      "title": "Pipeline Status",
      "type": "stat",
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 20,
        "y": 0
      },
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "PDEE91DDB90597936"
      },
      "targets": [
        {
          "rawSql": "SELECT if(max(inserted_at) >= now() - INTERVAL 10 MINUTE, 'LIVE', 'STALE') as status FROM cdc_pipeline.raw_orders",
          "refId": "A",
          "format": 1
        }
      ],
      "fieldConfig": {
        "defaults": {
          "mappings": [
            {
              "type": "value",
              "options": {
                "LIVE": {
                  "color": "green",
                  "text": "LIVE"
                },
                "STALE": {
                  "color": "red",
                  "text": "STALE"
                }
              }
            }
          ]
        }
      },
      "options": {
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ]
        },
        "colorMode": "background",
        "graphMode": "none"
      }
    },
    {
      "id": 5,
      "title": "Order Volume by Symbol (5min Windows)",
      "type": "timeseries",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 4
      },
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "PDEE91DDB90597936"
      },
      "targets": [
        {
          "rawSql": "SELECT window_start as time, symbol, total_amount FROM cdc_pipeline.order_aggregations WHERE window_start >= now() - INTERVAL 1 HOUR ORDER BY window_start",
          "refId": "A",
          "format": 1
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "currencyKRW",
          "custom": {
            "drawStyle": "bars",
            "fillOpacity": 80,
            "stacking": {
              "mode": "normal"
            }
          }
        }
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "multi"
        }
      }
    },
    {
      "id": 6,
      "title": "CDC Latency (ms)",
      "type": "timeseries",
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 4
      },
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "PDEE91DDB90597936"
      },
      "targets": [
        {
          "rawSql": "SELECT source_ts as time, cdc_latency_ms as latency, symbol FROM cdc_pipeline.raw_orders WHERE op IN ('c', 'u', 'd') AND source_ts >= now() - INTERVAL 1 HOUR ORDER BY source_ts",
          "refId": "A",
          "format": 1
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "custom": {
            "drawStyle": "points",
            "pointSize": 6
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 50
              },
              {
                "color": "red",
                "value": 200
              }
            ]
          },
          "color": {
            "mode": "thresholds"
          }
        }
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "multi"
        }
      }
    },
    {
      "id": 7,
      "title": "Buy vs Sell by Symbol",
      "type": "barchart",
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 0,
        "y": 12
      },
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "PDEE91DDB90597936"
      },
      "targets": [
        {
          "rawSql": "SELECT symbol, sumIf(order_count, 1=1) as total, sumIf(buy_count, 1=1) as buy, sumIf(sell_count, 1=1) as sell FROM cdc_pipeline.order_aggregations GROUP BY symbol ORDER BY total DESC",
          "refId": "A",
          "format": 1
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": {
            "fillOpacity": 80
          }
        }
      },
      "options": {
        "xField": "symbol",
        "stacking": "normal",
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        }
      }
    },
    {
      "id": 8,
      "title": "Anomaly Alerts",
      "type": "table",
      "gridPos": {
        "h": 8,
        "w": 16,
        "x": 8,
        "y": 12
      },
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "PDEE91DDB90597936"
      },
      "targets": [
        {
          "rawSql": "SELECT detected_at as time, alert_type, symbol, message, value, threshold FROM cdc_pipeline.anomaly_alerts ORDER BY detected_at DESC LIMIT 50",
          "refId": "A",
          "format": 1
        }
      ],
      "fieldConfig": {
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "alert_type"
            },
            "properties": [
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-text"
                }
              },
              {
                "id": "mappings",
                "value": [
                  {
                    "type": "value",
                    "options": {
                      "LARGE_ORDER": {
                        "color": "orange"
                      },
                      "HIGH_AMOUNT": {
                        "color": "red"
                      },
                      "PRICE_SPIKE": {
                        "color": "yellow"
                      },
                      "RAPID_ORDERS": {
                        "color": "purple"
                      }
                    }
                  }
                ]
              }
            ]
          }
        ]
      },
      "options": {
        "showHeader": true,
        "sortBy": [
          {
            "displayName": "time",
            "desc": true
          }
        ]
      }
    },
    {
      "id": 9,
      "title": "Recent Orders (Live)",
      "type": "table",
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 20
      },
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "PDEE91DDB90597936"
      },
      "targets": [
        {
          "rawSql": "SELECT source_ts as time, op, order_id, symbol, order_type, quantity, price, total_amount, status, cdc_latency_ms FROM cdc_pipeline.raw_orders ORDER BY source_ts DESC LIMIT 30",
          "refId": "A",
          "format": 1
        }
      ],
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "order_type"
            },
            "properties": [
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-text"
                }
              },
              {
                "id": "mappings",
                "value": [
                  {
                    "type": "value",
                    "options": {
                      "BUY": {
                        "color": "red",
                        "text": "BUY"
                      },
                      "SELL": {
                        "color": "blue",
                        "text": "SELL"
                      }
                    }
                  }
                ]
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "total_amount"
            },
            "properties": [
              {
                "id": "unit",
                "value": "currencyKRW"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "cdc_latency_ms"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              }
            ]
          }
        ]
      },
      "options": {
        "showHeader": true,
        "sortBy": [
          {
            "displayName": "time",
            "desc": true
          }
        ]
      }
    }
  ],
  "schemaVersion": 39,
  "version": 1
}