{
  "id": null,
  "uid": "cdc-pipeline-main",
  "title": "CDC Crypto Realtime Pipeline",
  "tags": ["cdc", "crypto", "flink", "clickhouse"],
  "timezone": "Asia/Seoul",
  "refresh": "10s",
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "panels": [
    {
      "id": 1,
      "title": "Total Trades",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 0, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT count() as total FROM cdc_pipeline.crypto_trades WHERE op = 'c'",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": {
        "defaults": {
          "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 10000 }, { "color": "red", "value": 100000 }] },
          "color": { "mode": "thresholds" }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none" }
    },
    {
      "id": 2,
      "title": "Avg CDC Latency",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 4, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT round(avg(cdc_latency_ms), 1) as avg_latency FROM cdc_pipeline.crypto_trades WHERE op = 'c' AND source_ts >= now() - INTERVAL 1 HOUR",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 100 }, { "color": "red", "value": 1000 }] },
          "color": { "mode": "thresholds" }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none" }
    },
    {
      "id": 3,
      "title": "Active Alerts",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 8, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT count() as alerts FROM cdc_pipeline.anomaly_alerts WHERE detected_at >= now() - INTERVAL 1 HOUR",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": {
        "defaults": {
          "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "orange", "value": 5 }, { "color": "red", "value": 20 }] },
          "color": { "mode": "thresholds" }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none" }
    },
    {
      "id": 4,
      "title": "Total Volume (KRW)",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 12, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT sum(trade_amount) as volume FROM cdc_pipeline.crypto_trades WHERE op = 'c' AND source_ts >= now() - INTERVAL 1 HOUR",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "currencyKRW",
          "thresholds": { "steps": [{ "color": "blue", "value": null }] },
          "color": { "mode": "thresholds" }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none" }
    },
    {
      "id": 10,
      "title": "Markets Tracked",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 16, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT uniq(market) as markets FROM cdc_pipeline.crypto_trades",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": {
        "defaults": {
          "thresholds": { "steps": [{ "color": "purple", "value": null }] },
          "color": { "mode": "thresholds" }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none" }
    },
    {
      "id": 11,
      "title": "Pipeline Status",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 20, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT if(max(inserted_at) >= now() - INTERVAL 5 MINUTE, 1, 0) as status FROM cdc_pipeline.crypto_trades",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": {
        "defaults": {
          "mappings": [{ "type": "value", "options": { "1": { "color": "green", "text": "● LIVE" }, "0": { "color": "red", "text": "○ STALE" } } }]
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none" }
    },
    {
      "id": 5,
      "title": "Trade Volume by Market (5min)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 4 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT window_start as time, market, total_amount FROM cdc_pipeline.trade_aggregations WHERE window_start >= now() - INTERVAL 1 HOUR ORDER BY window_start",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "currencyKRW",
          "custom": { "drawStyle": "bars", "fillOpacity": 80, "stacking": { "mode": "normal" } }
        }
      },
      "options": { "legend": { "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } }
    },
    {
      "id": 6,
      "title": "CDC Latency (ms)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 4 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT toStartOfMinute(source_ts) as time, avg(cdc_latency_ms) as avg_latency, max(cdc_latency_ms) as max_latency FROM cdc_pipeline.crypto_trades WHERE op = 'c' AND source_ts >= now() - INTERVAL 1 HOUR GROUP BY time ORDER BY time",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 20 },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 50 }, { "color": "red", "value": 200 }] },
          "color": { "mode": "thresholds" }
        }
      },
      "options": { "legend": { "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } }
    },
    {
      "id": 12,
      "title": "BTC Price (Realtime)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT toStartOfMinute(source_ts) as time, avg(trade_price) as price, min(trade_price) as low, max(trade_price) as high FROM cdc_pipeline.crypto_trades WHERE market = 'KRW-BTC' AND op = 'c' AND source_ts >= now() - INTERVAL 1 HOUR GROUP BY time ORDER BY time",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "currencyKRW",
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 10 }
        }
      },
      "options": { "legend": { "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } }
    },
    {
      "id": 7,
      "title": "Bid vs Ask by Market",
      "type": "barchart",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT market, sum(bid_count) as bid, sum(ask_count) as ask FROM cdc_pipeline.trade_aggregations WHERE window_start >= now() - INTERVAL 1 HOUR GROUP BY market ORDER BY bid + ask DESC",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": { "defaults": { "custom": { "fillOpacity": 80 } } },
      "options": { "xField": "market", "stacking": "normal", "legend": { "displayMode": "list", "placement": "bottom" } }
    },
    {
      "id": 8,
      "title": "Anomaly Alerts",
      "type": "table",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 20 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT detected_at as time, alert_type, market, message, value, threshold FROM cdc_pipeline.anomaly_alerts ORDER BY detected_at DESC LIMIT 50",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": {
        "overrides": [{
          "matcher": { "id": "byName", "options": "alert_type" },
          "properties": [{
            "id": "custom.cellOptions", "value": { "type": "color-text" }
          }, {
            "id": "mappings",
            "value": [{ "type": "value", "options": { "LARGE_TRADE": { "color": "orange" }, "PRICE_SPIKE": { "color": "red" }, "VOLUME_SURGE": { "color": "yellow" }, "RAPID_TRADES": { "color": "purple" } } }]
          }]
        }]
      },
      "options": { "showHeader": true, "sortBy": [{ "displayName": "time", "desc": true }] }
    },
    {
      "id": 9,
      "title": "Recent Trades (Live)",
      "type": "table",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 28 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "PDEE91DDB90597936" },
      "targets": [{
        "rawSql": "SELECT source_ts as time, market, ask_bid, trade_price, trade_volume, trade_amount, cdc_latency_ms FROM cdc_pipeline.crypto_trades WHERE op = 'c' ORDER BY source_ts DESC LIMIT 30",
        "refId": "A",
        "format": 1
      }],
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "ask_bid" },
            "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-text" } }, { "id": "mappings", "value": [{ "type": "value", "options": { "BID": { "color": "red", "text": "BID (매수)" }, "ASK": { "color": "blue", "text": "ASK (매도)" } } }] }]
          },
          { "matcher": { "id": "byName", "options": "trade_amount" }, "properties": [{ "id": "unit", "value": "currencyKRW" }] },
          { "matcher": { "id": "byName", "options": "cdc_latency_ms" }, "properties": [{ "id": "unit", "value": "ms" }] }
        ]
      },
      "options": { "showHeader": true, "sortBy": [{ "displayName": "time", "desc": true }] }
    }
  ],
  "schemaVersion": 39,
  "version": 2
}
